version: 2.1

orbs:
  docker: circleci/docker@2.2.0

# Path filtering configuration - triggers specific workflows based on changed files
parameters:
  run-app-build:
    type: boolean
    default: false
  run-k8s-validation:
    type: boolean
    default: false
  run-infrastructure:
    type: boolean
    default: false

workflows:
  # Main workflow - runs on every commit
  main:
    when:
      not:
        or:
          - << pipeline.parameters.run-app-build >>
          - << pipeline.parameters.run-k8s-validation >>
          - << pipeline.parameters.run-infrastructure >>
    jobs:
      - detect-changes
      - backend-build-and-test:
          requires:
            - detect-changes
      - frontend-build-and-test:
          requires:
            - detect-changes
      - k8s-validate:
          requires:
            - detect-changes
      - build-and-push-images:
          requires:
            - backend-build-and-test
            - frontend-build-and-test
          filters:
            branches:
              only:
                - main
                - master

  # Application-specific workflow
  app-workflow:
    when: << pipeline.parameters.run-app-build >>
    jobs:
      - backend-build-and-test
      - frontend-build-and-test
      - build-and-push-images:
          requires:
            - backend-build-and-test
            - frontend-build-and-test
          filters:
            branches:
              only:
                - main
                - master

  # Kubernetes validation workflow
  k8s-workflow:
    when: << pipeline.parameters.run-k8s-validation >>
    jobs:
      - k8s-validate

jobs:
  detect-changes:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Detect changed files
          command: |
            echo "Checking for changes in different directories..."
            git diff --name-only HEAD~1 HEAD || echo "No previous commit to compare"

  backend-build-and-test:
    docker:
      - image: cimg/node:18.18
    working_directory: ~/project
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-backend-dependencies-{{ checksum "apps/surprise-me-backend/package.json" }}
            - v1-backend-dependencies-
      - run:
          name: Install backend dependencies
          command: |
            cd apps/surprise-me-backend
            npm install
      - save_cache:
          paths:
            - apps/surprise-me-backend/node_modules
          key: v1-backend-dependencies-{{ checksum "apps/surprise-me-backend/package.json" }}
      - run:
          name: Run backend tests
          command: |
            cd apps/surprise-me-backend
            echo "No tests configured yet - skipping test phase"
            npm run --if-present test
      - run:
          name: Backend security audit
          command: |
            cd apps/surprise-me-backend
            npm audit --audit-level moderate

  frontend-build-and-test:
    docker:
      - image: cimg/node:18.18
    working_directory: ~/project
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-frontend-dependencies-{{ checksum "apps/surprise-me-frontend/package.json" }}
            - v1-frontend-dependencies-
      - run:
          name: Install frontend dependencies
          command: |
            cd apps/surprise-me-frontend
            npm install
      - save_cache:
          paths:
            - apps/surprise-me-frontend/node_modules
          key: v1-frontend-dependencies-{{ checksum "apps/surprise-me-frontend/package.json" }}
      - run:
          name: Run frontend tests
          command: |
            cd apps/surprise-me-frontend
            echo "No tests configured yet - skipping test phase"
            npm run --if-present test
      - run:
          name: Frontend security audit
          command: |
            cd apps/surprise-me-frontend
            npm audit --audit-level moderate

  k8s-validate:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install kubectl
          command: |
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
      - run:
          name: Validate Kubernetes manifests
          command: |
            echo "Validating Kubernetes manifests..."
            find k8s/ -name "*.yaml" -o -name "*.yml" | while read manifest; do
              echo "Validating $manifest"
              kubectl --dry-run=client apply -f "$manifest" || echo "Warning: $manifest may have issues"
            done
      - run:
          name: Check for security issues
          command: |
            echo "Checking for common security anti-patterns..."
            # Check for privileged containers
            if grep -r "privileged.*true" k8s/; then
              echo "WARNING: Found privileged containers"
            fi
            # Check for root user
            if grep -r "runAsUser.*0" k8s/; then
              echo "WARNING: Found containers running as root"
            fi

  build-and-push-images:
    docker:
      - image: cimg/base:stable
    working_directory: ~/project
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build Docker images
          command: |
            # Get the short commit SHA
            SHORT_SHA=$(echo $CIRCLE_SHA1 | cut -c1-7)

            # Set image tag - use version tag if available, otherwise use branch-sha
            if [ -n "$CIRCLE_TAG" ]; then
              IMAGE_TAG=$CIRCLE_TAG
            else
              IMAGE_TAG="${CIRCLE_BRANCH}-${SHORT_SHA}"
            fi

            # Set default username if not provided
            DOCKERHUB_USERNAME=${DOCKERHUB_USERNAME:-"sumitchinchansure"}

            echo "Building images with tag: $IMAGE_TAG"

            # Build backend image
            echo "Building backend image..."
            cd apps/surprise-me-backend
            docker build -t $DOCKERHUB_USERNAME/surprise-me-backend:$IMAGE_TAG .
            docker build -t $DOCKERHUB_USERNAME/surprise-me-backend:latest .
            cd ../..

            # Build frontend image
            echo "Building frontend image..."
            cd apps/surprise-me-frontend
            docker build -t $DOCKERHUB_USERNAME/surprise-me-frontend:$IMAGE_TAG .
            docker build -t $DOCKERHUB_USERNAME/surprise-me-frontend:latest .
            cd ../..
      - run:
          name: Login to Docker Hub
          command: |
            DOCKERHUB_USERNAME=${DOCKERHUB_USERNAME:-"sumitchinchansure"}
            echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
      - run:
          name: Push Docker images
          command: |
            # Get the short commit SHA
            SHORT_SHA=$(echo $CIRCLE_SHA1 | cut -c1-7)

            # Set default username if not provided
            DOCKERHUB_USERNAME=${DOCKERHUB_USERNAME:-"sumitchinchansure"}

            # Set image tag
            if [ -n "$CIRCLE_TAG" ]; then
              IMAGE_TAG=$CIRCLE_TAG
            else
              IMAGE_TAG="${CIRCLE_BRANCH}-${SHORT_SHA}"
            fi

            echo "Pushing images with tag: $IMAGE_TAG"

            # Push backend images
            echo "Pushing backend image..."
            docker push $DOCKERHUB_USERNAME/surprise-me-backend:$IMAGE_TAG

            # Push frontend images
            echo "Pushing frontend image..."
            docker push $DOCKERHUB_USERNAME/surprise-me-frontend:$IMAGE_TAG

            # Only push latest tag for main/master branch or version tags
            if [ "$CIRCLE_BRANCH" = "master" ] || [ "$CIRCLE_BRANCH" = "main" ] || [ -n "$CIRCLE_TAG" ]; then
              echo "Pushing latest tags..."
              docker push $DOCKERHUB_USERNAME/surprise-me-backend:latest
              docker push $DOCKERHUB_USERNAME/surprise-me-frontend:latest
            fi
      - run:
          name: Update Kubernetes manifests
          command: |
            echo "Images built and pushed successfully!"
            echo "Backend: $DOCKERHUB_USERNAME/surprise-me-backend:$IMAGE_TAG"
            echo "Frontend: $DOCKERHUB_USERNAME/surprise-me-frontend:$IMAGE_TAG"